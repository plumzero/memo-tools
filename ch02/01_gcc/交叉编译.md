

制作交叉编译器的机器是`build`，交叉编译器运行所在机器是`host`，而交叉编译器编译出来的程序运行所在的机器是`target`。三者都相同叫`native`编译，仅前两者相同叫`cross`编译。

这里的测试 build 和 host 都是 x86_64-linux-gnu，而 target 为 aarch64-linux-gnu。

工作目录为 ~/cross 。

安装必备工具:
```s
  sudo apt install make gcc g++ libgmp-dev libmpfr-dev libmpc-dev gawk bison texinfo
```

用如下命令在 target 机器上分别查看 kernel、binutils、gcc、glibc 的版本号:
```s
  uname -a
  ld --version
  gcc --version
  ldd --version
```
根据这些版本号下载 kernel、binutils、gcc、glibc 的源码:
```s
  cd ~/cross
  export PATH=$HOME/cross/bin:$PATH
  wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.10.tar.xz
  wget https://ftp.gnu.org/gnu/binutils/binutils-2.34.tar.xz
  wget https://ftp.gnu.org/gnu/gcc/gcc-9.3.0/gcc-9.3.0.tar.xz
  wget https://ftp.gnu.org/gnu/glibc/glibc-2.31.tar.xz
```
注意，如果 target 机器的内核被修改过，如被打过实时补丁，那么需要先对上边下载的 kernel 源码也打上相应的补丁，这样才能进入下一步。

安装内核头文件和 binutils:
```s
  cd ~/cross
  tar -Jxvf linux-5.10.tar.xz
  cd linux-5.10
  make ARCH=arm64 INSTALL_HDR_PATH=$HOME/cross/aarch64-linux-gnu headers_install

  cd ~/cross
  tar -Jxvf binutils-2.34.tar.xz
  cd binutils-2.34
  mkdir build
  cd build
  ../configure --prefix=$HOME/cross --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=aarch64-linux-gnu --disable-multilib
  make -j4
  make install
```

制作目录结构，建立符号链接:
```s
  cd ~/cross
  mkdir sysroot
  cd sysroot
  ln -s ../aarch64-linux-gnu usr
  # cd sysroot
  # mkdir -p ./$HOME/cross
  # cd ./$HOME/cross
  # ln -s ../../../../aarch64-linux-gnu aarch64-linux-gnu
  # mkdir -p ./usr/local/
  # cd ./usr/local
  # ln -s ../../../aarch64-linux-gnu aarch64-linux-gnu
```
上面的操作，以及接下来 configure gcc 时使用 --with-sysroot 选项，都是为了使制作出来的交叉编译器是便携的，即可以将其置于任意路径下使用。

第 1 次编译 gcc 和 glibc:
```s
  cd ~/cross
  tar -Jxvf gcc-9.3.0.tar.xz
  cd gcc-9.3.0
  mkdir build
  cd build
  ../configure --prefix=$HOME/cross --with-sysroot=$HOME/cross/sysroot --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=aarch64-linux-gnu --enable-languages=c,c++ --disable-multilib
  make -j4 all-gcc
  make install-gcc

  cd ~/cross
  tar -Jxvf glibc-2.31.tar.xz
  cd glibc-2.31
  mkdir build
  cd build
  ../configure --prefix=$HOME/cross/aarch64-linux-gnu --build=x86_64-linux-gnu --host=aarch64-linux-gnu --with-headers=$HOME/cross/aarch64-linux-gnu/include --disable-multilib libc_cv_forced_unwind=yes
  make install-bootstrap-headers=yes install-headers
  make -j4 csu/subdir_lib
  install csu/crt1.o csu/crti.o csu/crtn.o $HOME/cross/aarch64-linux-gnu/lib

  $HOME/cross/bin/aarch64-linux-gnu-gcc -nostdlib -nostartfiles -shared -x c /dev/null -o $HOME/cross/aarch64-linux-gnu/lib/libc.so
  touch $HOME/cross/aarch64-linux-gnu/include/gnu/stubs.h
```
仍有问题，待续...

第 2 次编译 gcc 和 glibc:
```s
  cd ~/cross
  cd gcc-9.3.0
  cd build
  make -j4 all-target-libgcc
  make install-target-libgcc
  
  cd ~/cross
  cd glibc-2.31
  cd build
  make -j4
  make install
```

在 ~/cross/gcc-9.3.0/libsanitizer/asan/asan_linux.cc 文件的第 66 行处插入以下内容:
```s
#ifndef PATH_MAX
#define PATH_MAX 4096
#endif
```

第 3 次编译 gcc:
```s
  cd ~/cross
  cd build
  make -j4
  make install
```

打包:
```s
  cd ~
  tar -Jcvf cross.tar.xz cross
```
